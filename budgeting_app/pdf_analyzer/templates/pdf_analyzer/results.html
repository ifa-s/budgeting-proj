{% load format_filters %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Analysis Results - VT Budget Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* Light theme colors */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-tertiary: #718096;
            --border-primary: rgba(134, 31, 65, 0.1);
            --border-secondary: #e9ecef;
            --accent-primary: #e87722;
            --accent-hover: #d16617;
        }
        
        [data-theme="dark"] {
            /* Dark theme colors */
            --bg-primary: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-tertiary: #cbd5e0;
            --border-primary: rgba(232, 119, 34, 0.3);
            --border-secondary: #4a5568;
            --accent-primary: #e87722;
            --accent-hover: #fd9444;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        
        .vt-header {
            background-color: var(--accent-primary);
            color: white;
            padding: 2rem 0;
            border-bottom: 1px solid var(--border-primary);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .header-info {
            flex: 1;
        }
        
        .header-title h2 {
            margin: 0;
            font-size: 1.8rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .file-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .file-name, .analysis-date {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-actions {
            flex-shrink: 0;
        }
        
        .results-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 1rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 1.5rem;
        }
        
        .metric-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-secondary);
            border-radius: 1.2rem;
            padding: 1.5rem;
            text-align: center;
            height: 100%;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }
        
        .positive { color: #28a745; }
        .negative { color: #dc3545; }
        .neutral { color: #6c757d; }
        
        .category-item {
            border-left: 4px solid var(--text-primary);
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background-color: var(--bg-secondary);
        }
        
        .card-header {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-primary);
            color: var(--text-primary);
        }
        
        .card-body {
            background-color: transparent;
            color: var(--text-primary);
        }
        
        .card-header {
            background-color: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-secondary);
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .btn-outline-light {
            color: var(--text-primary);
            border: 1px solid var(--border-secondary);
            background-color: transparent;
        }
        
        .btn-outline-light:hover {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border-color: var(--border-primary);
        }
        
        .text-muted {
            color: var(--text-tertiary) !important;
        }
        
        .badge {
            background-color: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-secondary);
        }
        

        
        .nav-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            justify-content: flex-end;
        }
        
        .nav-buttons .btn {
            padding: 0.5rem 0.75rem;
            font-size: 1.2rem;
            border-radius: 8px;
            min-width: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .financial-insights, .recommendations-content {
            white-space: pre-line;
            line-height: 1.6;
        }
        
        /* Enhanced formatting for bullet points and bold text */
        .financial-insights ul, .recommendations-content ul, .small ul {
            margin: 0.5rem 0;
            padding-left: 1.2rem;
        }
        
        .financial-insights li, .recommendations-content li, .small li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }
        
        .financial-insights strong, .recommendations-content strong, .small strong {
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        /* Risk assessment specific styling */
        .small ul {
            color: #dc3545;
        }
        
        .small strong {
            color: #dc3545;
            font-weight: 700;
        }
        
        .disclaimer {
            background-color: var(--warning-bg);
            border: 1px solid var(--warning-border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1.5rem 0;
            color: var(--warning-text);
        }
        
        .disclaimer-title {
            font-weight: bold;
            color: var(--warning-text);
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .disclaimer-title i {
            margin-right: 0.5rem;
        }

        .footer {
            background-color: var(--bg-secondary);
            border-top: 1px solid var(--border-secondary);
            padding: 1rem 0;
            text-align: center;
            color: var(--text-tertiary);
            font-size: 0.875rem;
            margin-top: 3rem;
        }
            background-color: #f8f9fa;
            border-radius: 0 8px 8px 0;
        }
        
        .transaction-item, .category-item {
            padding: 0.75rem;
            border-bottom: 1px solid var(--border-secondary);
            transition: background-color 0.2s ease;
        }
        
        .transaction-item:last-child, .category-item:last-child {
            border-bottom: none;
        }
        
        .transaction-item:hover, .category-item:hover {
            background-color: var(--bg-tertiary);
        }
        
        .badge-debit { background-color: #dc3545; }
        .badge-credit { background-color: #28a745; }
        .badge-fee { background-color: #ffc107; color: #000; }
        .badge-interest { background-color: #17a2b8; }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 1rem;
        }
        
        .insight-card {
            border-left: 4px solid #dc3545;
            background-color: var(--error-bg);
            border-radius: 8px;
            padding: 1rem;
        }
        
        .recommendation-item {
            background-color: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-left: 4px solid var(--accent-primary);
        }
        
        .action-item {
            background-color: var(--success-bg);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid #22c55e;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="vt-header">
        <div class="container">
            <div class="header-content">
                <div class="header-info">
                    <div class="header-title">
                        <h2>üí∞ Financial Analysis Results</h2>
                        <div class="file-info">
                            <span class="file-name">üìÑ {{ pdf_upload.file_name }}</span>
                            <span class="analysis-date">üïí {{ analysis.analyzed_at|date:"M j, Y g:i A" }}</span>
                        </div>
                    </div>
                </div>
                <div class="header-actions">
                    <div class="nav-buttons">
                        <a href="/landing/" class="btn btn-outline-light" title="Home">
                            üè†
                        </a>
                        <a href="/chat/" class="btn btn-outline-light" title="Budget Chat">
                            üí¨
                        </a>
                        <a href="{% url 'pdf_analyzer:index' %}" class="btn btn-outline-light" title="Analyze Another">
                            ‚ûï
                        </a>
                        <button class="btn btn-outline-light" id="themeToggle" aria-label="Toggle theme" title="Toggle Theme">
                            <span id="themeIcon">üåô</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container mt-4">
        <!-- Financial Overview -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value positive">
                        <i class="fas fa-arrow-up"></i> ${{ analysis.total_income|floatformat:2 }}
                    </div>
                    <h6>Total Income</h6>
                    <p class="small text-muted">Money coming in</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value negative">
                        <i class="fas fa-arrow-down"></i> ${{ analysis.total_expenses|floatformat:2 }}
                    </div>
                    <h6>Total Expenses</h6>
                    <p class="small text-muted">Money going out</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="metric-card">
                    <div class="metric-value {% if analysis.net_change >= 0 %}positive{% else %}negative{% endif %}">
                        {% if analysis.net_change >= 0 %}
                            <i class="fas fa-plus"></i> ${{ analysis.net_change|floatformat:2 }}
                        {% else %}
                            <i class="fas fa-minus"></i> ${{ analysis.net_change|floatformat:2|cut:"-" }}
                        {% endif %}
                    </div>
                    <h6>Net Change</h6>
                    <p class="small text-muted">
                        {% if analysis.net_change >= 0 %}You saved money!{% else %}You overspent{% endif %}
                    </p>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Left Column: Charts and Categories -->
            <div class="col-lg-8">
                <!-- Spending Breakdown Chart -->
                <div class="card results-card">
                    <div class="card-header">
                        <h5>üìä Expense Breakdown</h5>
                        <p class="text-muted mb-3">Analysis of your spending by category (income excluded)</p>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="spendingChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Category Details -->
                <div class="card results-card">
                    <div class="card-header">
                        <h5><i class="fas fa-tags"></i> Category Analysis</h5>
                    </div>
                    <div class="card-body">
                        {% for category in category_summaries %}
                            <div class="category-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <strong>{{ category.category_name|title }}</strong>
                                        <div class="small text-muted">{{ category.transaction_count }} transaction{{ category.transaction_count|pluralize }}</div>
                                    </div>
                                    <div class="text-end">
                                        <strong>${{ category.total_amount|floatformat:2 }}</strong>
                                        <div class="small text-muted">{{ category.percentage_of_expenses }}% of expenses</div>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <p class="text-muted">No spending categories found.</p>
                        {% endfor %}
                    </div>
                </div>

                <!-- Recent Transactions -->
                <div class="card results-card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-list"></i> Recent Transactions</h5>
                        <small class="text-muted">Showing {{ transactions.count }} of {{ transaction_count }} total</small>
                    </div>
                    <div class="card-body">
                        <div style="max-height: 400px; overflow-y: auto;">
                            {% for transaction in transactions %}
                                <div class="transaction-item">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <div>
                                            <strong>{{ transaction.description|truncatechars:50 }}</strong>
                                            <div class="small text-muted">
                                                {{ transaction.date|date:"M j, Y" }} ‚Ä¢ 
                                                <span class="badge badge-{{ transaction.transaction_type }}">
                                                    {{ transaction.transaction_type|title }}
                                                </span>
                                                <span class="badge bg-secondary">{{ transaction.category|title }}</span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <strong class="{% if transaction.transaction_type == 'credit' %}positive{% else %}negative{% endif %}">
                                                {% if transaction.transaction_type == 'credit' %}+${{ transaction.amount|floatformat:2 }}{% else %}-${{ transaction.amount|floatformat:2|cut:"-" }}{% endif %}
                                            </strong>
                                        </div>
                                    </div>
                                </div>
                            {% empty %}
                                <p class="text-muted">No transactions found.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: AI Insights -->
            <div class="col-lg-4">
                <!-- Financial Disclaimer -->
                <div class="disclaimer">
                    <div class="disclaimer-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Important Disclaimer
                    </div>
                    <p class="mb-0">
                        <strong>This analysis is for informational purposes only and does not constitute professional financial advice.</strong> 
                        The insights and recommendations provided are generated by AI and should not replace consultation with 
                        licensed financial advisors, accountants, or other qualified professionals. Always consult with appropriate 
                        professionals before making financial decisions.
                    </p>
                </div>

                <!-- AI Insights -->
                <div class="card results-card insight-card">
                    <div class="card-header">
                        <h5><i class="fas fa-robot"></i> AI Insights</h5>
                    </div>
                    <div class="card-body">
                        <div class="financial-insights" id="financial-insights-content">{{ analysis.financial_insights|format_bullets }}</div>
                        
                        {% if analysis.risk_assessment %}
                            <div class="mt-3">
                                <h6><i class="fas fa-exclamation-triangle text-warning"></i> Risk Assessment</h6>
                                <div class="small">{{ analysis.risk_assessment|format_bullets }}</div>
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Budgeting Recommendations -->
                <div class="card results-card">
                    <div class="card-header">
                        <h5><i class="fas fa-lightbulb"></i> Recommendations</h5>
                    </div>
                    <div class="card-body">
                        {% if analysis.budgeting_recommendations %}
                            <div class="recommendations-content" id="recommendations-content">
                                {{ analysis.budgeting_recommendations|format_bullets }}
                            </div>
                        {% endif %}
                        
                        {% for recommendation in student_recommendations %}
                            <div class="recommendation-item">
                                <i class="fas fa-graduation-cap text-primary me-2"></i>
                                {{ recommendation }}
                            </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Action Items -->
                {% if analysis.spending_patterns.action_items %}
                    <div class="card results-card">
                        <div class="card-header">
                            <h5><i class="fas fa-tasks"></i> Action Items</h5>
                        </div>
                        <div class="card-body">
                            {% for action in analysis.spending_patterns.action_items %}
                                <div class="action-item">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    {{ action }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}

                <!-- Student Spending Patterns -->
                {% if student_patterns %}
                    <div class="card results-card">
                        <div class="card-header">
                            <h5><i class="fas fa-graduation-cap"></i> Student Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="small">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Dining Out:</span>
                                    <strong>{{ student_patterns.dining_out_frequency }} times</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Entertainment:</span>
                                    <strong>${{ student_patterns.entertainment_spending|floatformat:2 }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Transportation:</span>
                                    <strong>${{ student_patterns.transportation_costs|floatformat:2 }}</strong>
                                </div>
                                {% if student_patterns.textbook_spending > 0 %}
                                    <div class="d-flex justify-content-between mb-2">
                                        <span>Textbooks/Education:</span>
                                        <strong>${{ student_patterns.textbook_spending|floatformat:2 }}</strong>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Actions -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <form method="post" action="{% url 'pdf_analyzer:delete_upload' pdf_upload.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger me-2" 
                            onclick="return confirm('Are you sure you want to delete this analysis?')">
                        <i class="fas fa-trash"></i> Delete Analysis
                    </button>
                </form>
                <a href="{% url 'pdf_analyzer:index' %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> Analyze Another Statement
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Global variable to store chart instance
        let spendingChart;
        
        // Function to get theme-appropriate colors
        function getThemeColors() {
            const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
            return {
                borderColor: isDark ? '#374151' : '#ffffff',
                textColor: isDark ? '#f9fafb' : '#333333'
            };
        }
        
        // Function to update chart colors based on theme
        function updateChartTheme() {
            if (spendingChart) {
                const colors = getThemeColors();
                spendingChart.data.datasets[0].borderColor = colors.borderColor;
                spendingChart.options.plugins.legend.labels.color = colors.textColor;
                spendingChart.update();
            }
        }
        
        // Spending Breakdown Chart
        document.addEventListener('DOMContentLoaded', function() {
            const chartElement = document.getElementById('spendingChart');
            if (!chartElement) return;
            
            const ctx = chartElement.getContext('2d');
            
            // Prepare chart data (excluding income categories)
            const categories = [
                {% for category in category_summaries %}
                    {% if 'income' not in category.category_name|lower and 'salary' not in category.category_name|lower and 'deposit' not in category.category_name|lower %}
                        '{{ category.category_name|title }}',
                    {% endif %}
                {% endfor %}
            ];
            
            const amounts = [
                {% for category in category_summaries %}
                    {% if 'income' not in category.category_name|lower and 'salary' not in category.category_name|lower and 'deposit' not in category.category_name|lower %}
                        {{ category.total_amount|floatformat:2 }},
                    {% endif %}
                {% endfor %}
            ];
            
            const colors = [
                '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF',
                '#FF9F40', '#FF6384', '#C9CBCF', '#4BC0C0', '#FF6384'
            ];
            
            const themeColors = getThemeColors();
            
            spendingChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: colors.slice(0, categories.length),
                        borderWidth: 2,
                        borderColor: themeColors.borderColor
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: themeColors.textColor
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = '$' + context.parsed.toFixed(2);
                                    const percentage = ((context.parsed / amounts.reduce((a, b) => a + b, 0)) * 100).toFixed(1);
                                    return label + ': ' + value + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        });
        
        // Convert markdown-style bold text and bullet points to HTML
        function convertMarkdownBold() {
            const elements = document.querySelectorAll('.financial-insights, .recommendations-content');
            elements.forEach(element => {
                if (element) {
                    let content = element.innerHTML;
                    // Convert **text** to <strong>text</strong>
                    content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    // Convert bullet points that start with ‚Ä¢ or *
                    content = content.replace(/^[‚Ä¢*]\s/gm, '<span style="color: #000; font-weight: bold;">‚Ä¢</span> ');
                    // Ensure line breaks are converted to <br> tags
                    content = content.replace(/\n/g, '<br>');
                    element.innerHTML = content;
                }
            });
        }
        
        // Run the conversion when the page loads
        convertMarkdownBold();

        // Theme toggle functionality (if theme toggle exists)
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            const themeIcon = document.getElementById('themeIcon');
            const html = document.documentElement;
            
            // Load saved theme or default to light
            const savedTheme = localStorage.getItem('theme') || 'light';
            html.setAttribute('data-theme', savedTheme);
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
            
            themeToggle.addEventListener('click', function() {
                const currentTheme = html.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                
                html.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                if (themeIcon) {
                    themeIcon.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                }
                
                // Update chart colors when theme changes
                updateChartTheme();
            });
        }
    </script>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <p class="mb-0">Made with ‚ù§Ô∏è in Blacksburg, VA</p>
        </div>
    </footer>
</body>
</html>